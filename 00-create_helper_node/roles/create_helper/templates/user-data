#cloud-config

# Hostname management
preserve_hostname: False
hostname: {{ bastion_vm_hostname_short}}
fqdn: {{ bastion_vm_hostname }}

# Setup Users with ssh keys
users:
    - default
    - name: helper
      groups: ['wheel']
      shell: /bin/bash
      sudo: ALL=(ALL) NOPASSWD:ALL
      ssh-authorized-keys:
        - {{ sshkeypub.content | b64decode }}

# Configure where output will go
output:
  all: ">> {{ vm_files_path }}/cloud-init.log"

# configure interaction with ssh server
ssh_genkeytypes: ['rsa']

ssh_authorized_keys:
  - {{ sshkeypub.content | b64decode }}

# set timezone for VM
timezone: America/New_York

# Setup static IP
bootcmd:
  - nmcli con mod eth0 connection.autoconnect yes
  - nmcli con mod eth0 ipv4.ignore-auto-dns yes
  - nmcli con mod eth0 ipv6.ignore-auto-dns yes
  - nmcli con mod eth0 ipv4.addresses {{ bastion_vm_ipaddress }}/24
  - nmcli con mod eth0 ipv4.method static
  - nmcli con mod eth0 ipv4.dns {{ bastion_vm_ipaddress }}
  - nmcli con mod eht0 ipv4.dns-search {{ network_domain }}
  - nmcli con reload
  - nmcli con up eth0
# Remove cloud-init
runcmd:
  - systemctl stop network && systemctl start network
  - dnf -y remove cloud-init
